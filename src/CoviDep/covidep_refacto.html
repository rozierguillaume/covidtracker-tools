
  <!-- wp:html -->

  <!--
  Guillaume Rozier - 2020

  L'ensemble du code est dans un seul fichier, car la page est ensuite intégrée dans une page Wordpress.
  Style en première partie, HTML ensuite, puis script JS à la fin.
  -->


  <style>
    html {
      scroll-behavior: smooth;
    }
    button[type=button_dep] {
    border: 0px solid;
    transition-duration: 0.2s;
    background-color: #ffffff;
    border-radius: 7px;
    box-shadow: 6px 4px 15px #d6d6d6;
    min-width: 130px;
    width: 20%;
    max-width: 160px;
    max-height: 90px;
    margin: 4px;
    }

  span[type=pourcent] {
      margin-left: 8px;
    font-size: 70%;
    vertical-align: middle;
  }

  .box-perso {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: nowrap;
  }

  progress {
     /*-webkit-appearance: none;*/
     /*appearance: none;*/
     width:100%;
     height: 4px;
     margin-top: 0px !important;
     margin-bottom: 0px !important;
     border-radius: 5px;

  }

  /* VALUE OF PROGRESSBAR */
  progress[type=green]::-webkit-progress-value{ /* Safari/Chrome */
      background:red;
      background-color: green;
      border-radius: 5px;
  }

  progress[type=greenv1]::-webkit-progress-value{ /* Safari/Chrome */
      background:red;
      background-color: #c3d9c4;
      border-radius: 5px;
  }


  progress[type=red]::-webkit-progress-value { /* Safari/Chrome */
      background:red;
      background-color: red;
      border-radius: 5px;
  }

  progress[type=redv1]::-webkit-progress-value { /* Safari/Chrome */
      background:red;
      background-color: #e3c6c3;
      border-radius: 5px;
  }

  /* REMAINING OF PROGRESSBAR */
  progress[type=green]::-webkit-progress-bar { /* Safari/Chrome */
      background:red;
      background-color: rgba(0, 0, 0, 0); /*#c3d9c4;*/
      border-radius: 5px;
    }

  progress[type=greenv1]::-webkit-progress-bar { /* Safari/Chrome */
      background:red;
      background-color: rgba(0, 0, 0, 0); /*#c3d9c4;*/
      border-radius: 5px;
    }


  progress[type=red]::-webkit-progress-bar { /* Safari/Chrome */
      background:red;
      background-color: rgba(0, 0, 0, 0); /*#e3c6c3;*/
      border-radius: 5px;
  }

  progress[type=redv1]::-webkit-progress-bar { /* Safari/Chrome */
      background:red;
      background-color: rgba(0, 0, 0, 0); /*#e3c6c3;*/
      border-radius: 5px;
  }

  /* FIREFOX */
  progress::-moz-progress-bar {  /* Firefox */
    background: red;  
    border-radius: 5px;
  } 

  button:hover {
    background-color: #F0F8FF; /* Green */
    color: black;
  }

  .buttonSelected[type=button_dep] {

    border: 3px solid black;
  }

  input[type=text] {
    width: 50px;
    border: 0.5px solid;
    border-radius: 7px;
    padding: 10px;
    box-shadow: 2px 2px 5px #d6d6d6;
  }
  input[type=text]:focus {
    border: 3px solid #555;
  }
  .divAvantVague {
    border: 0px solid black;
    margin-top: 20px;
    margin-left:10px;
    padding: 10px 30px;
    border-radius: 7px;
    max-width: 800px;
    text-align: left;
    box-shadow: 6px 4px 25px #c5e07b;
    }

    .divApresVague {
    border: 0px solid black;
    margin-top: 20px;
    margin-left:10px;
    padding: 10px 30px;
    border-radius: 7px;
    max-width: 800px;
    text-align: left;
    box-shadow: 6px 4px 25px #ffa29c;
    }

    .divImage {
    border: 0px solid black;
    margin-top: 20px;
    margin-left:10px;
    padding: 10px 30px;
    border-radius: 7px;
    min-height:300px;
    max-width: 800px;
    text-align: left;

    }
  </style>


  <style>
  /* the flex container without mediaquerie */

  div[class_perso] {
    display: flex;
    min-height: 10vh;
    min-width: 10vh;
    max-width: 80vh;
    max-height: 20vh;
    flex-wrap: wrap;
    /* needed to stack children once to big */
  }

  div[class_perso2] {
    display: flex;
    min-height: 10vh;
    min-width: 10vh;
    max-width: 80vh;
    max-height: 20vh;
    flex-wrap: wrap;
    /* needed to stack children once to big */
  }

  div[class_perso] div {
    flex: 1;
    min-height: 30vh;
    min-width: 200px;
    /* 2 children + margin and borders makes a break point at around 620px */
    /*background: lightblue;*/
  }

  div div {
    /*border: solid;*/
    margin: 3px;
    /*background: tomato;*/
  }


  /* remove the grid system at about 620px */

  @media screen and (max-width: 621px) {
    div[class_persos] {
      min-height: 30vh;
      /* has a meaning with a grid system */
    }

  }

  .wrap {
    display: flex;
    margin-top: 30px;
  }

  .one {
      border: 0px solid black;
    margin-top: 20px;
    margin-left:10px;
    padding: 5px 10px;
    border-radius: 7px;
    max-width: 1200px;
    text-align: left;
    /*box-shadow: 6px 4px 25px #c3d19d;*/
    box-shadow: 0 0 0 transparent, 0 0 0 transparent, 6px 4px 25px #c3d19d;
    width: 50%;
    background: #ffffff;
  }

  .two {
      border: 0px solid black;
    margin-top: 20px;
    margin-left:20px;
    padding: 5px 10px;
    border-radius: 7px;
    max-width: 1200px;
    text-align: left;
    /*  box-shadow: 6px 4px 25px #ffa29c;*/
    box-shadow: 0 0 0 transparent, 0 0 0 transparent, 6px 4px 25px #ffa29c;
    background: #ffffff;

    width: 50%;
  }

  .three {
    border: 1px solid black;
    margin-top: 20px;
    margin-left:20px;
    padding: 10px 30px;
    border-radius: 7px;
    max-width: 900;
    text-align: left;
    width: 100%;
  }

  @media (max-width: 767px) {
    .wrap {
      flex-direction: column;
    }
    .one,
    .two,
    .three {
      width: auto;
      margin-left: 1px;
      margin-right: 1px;
    }
  }
  </style>



  <h3>Mon département a-t-il dépassé la première vague ?</h3>
  <p>CoviDep est un outil qui présente les départements ayant dépassé le nombre d'hospitalisations pour Covid19 du pic de la première vague et ceux ne l'ayant pas encore dépassé. Vous pouvez sélectionner un département dans la liste ci-dessous, ou alors dans les tableaux en bas de page. Les données proviennent de Santé publique France et sont mises à jour quotidiennement.</p>


  <div class="wrap">
   <div class="three">
      <center>
      <select name="deps_list_choice" id="deps_list_choice" onchange="listHasChanged();">
        <option value="">-- Choisissez un département--</option> 
      </select>
      </center>

      <h3 id="resultat"></h3>
      <p id="resultat_chiffres" style="margin-bottom: 30px;"></p>

      <center>
          <span id="img" class="">Sélectionnez un département.<br></span>
          <br>
          <br>
          Vous trouverez d'autres graphique sur le <b><a href="https://covidtracker.fr/dashboard-departements">Dashboard Départements ></a></b>
          <br>
      </center>
    </div>
  </div>


  <div class="wrap">

      <div class="two">
      <span style="color: red; margin-left: 10px; margin-top:20px; font-size:500%; display: inline-block;" id="nb_apres_vague">--</span> 
       <h3 style="color: red; margin-bottom: 20px; margin-left: 10px; margin-top: 0px;">
            départements ont dépassé la première vague
          </h3>
          <span style="margin-left: 10px;" id="maj-1"><i>Mise à jour : -/-</i></span>
          <p style="margin-left: 10px; font-size:100%">Classement par ordre décroissant d'hospitalisations actuelles. La barre rose représente la hauteur de la première vague, et la barre rouge la hauteur de la vague actuelle. Le taux représente l'évolution de la hauteur de la deuxième vague par rapport à la première.</p>
          <br>
          <center>
          <span id="apres_vague">
          </span>
          </center>

    </div>

   <div class="one">
      <span style="color: green; margin-left: 10px; margin-top:20px; font-size:500%; display: inline-block;" id="nb_avant_vague">--</span> 
      <h3 style="color: green; margin-bottom: 20px; margin-left: 10px; margin-top: 0px;">
            départements n'ont pas dépassé la première vague
          </h3>
          <span style="margin-left: 10px;" id="maj-2"><i>Mise à jour : -/-</i></span>
          <p style="margin-left: 10px; font-size:100%">Classement par ordre décroissant d'hospitalisations actuelles. La barre vert clair représente la hauteur de la première vague, et la barre vert foncé la hauteur de la vague actuelle. Le taux représente l'évolution de la hauteur de la deuxième vague par rapport à la première.</p><br>
          <center>
          <span id="avant_vague">
            </center>
          </span>
      </div>


  </div>

  <p style="margin-bottom:1cm;"></p>

  <div class="wp-block-button is-style-outline"><a class="wp-block-button__link" href="https://lydia-app.com/collect/covidtracker/fr" target="_blank" rel="noreferrer noopener">☕️ Offrez-moi un café</a></div>
  <br>
  <p>N'hésitez pas à partager CoviDep autour de vous ! Le lien est simple : <a href="https://covidtracker.fr/covidep">covidtracker.fr/covidep</a>.</p>
  <p>Une erreur ? Merci de <a href="https://covidtracker.fr/contact">me contacter</a>.</p>
  <p>Auteur : <a href="https://twitter.com/guillaumerozier">Guillaume Rozier</a>. Merci à <a href="https://twitter.com/eorphelin">Elias Orphelin</a>, et aux beta-testeurs.</p>

  <p style="margin-bottom:5cm;"></p>


  <script>
    var deps_avant_vague = ["Chargement..."];
    var deps_apres_vague = ["Chargement..."];
    var all_deps_with_num = [];
    var nb_hosp_dep = {};
    var selectedDep = "";
    var numero_deps= {};
    var maj = "";

    fetch('https://raw.githubusercontent.com/rozierguillaume/covid-19/master/data/france/stats/risk_rates.json')
     .then(response => {
         if (!response.ok) {
             throw new Error("HTTP error " + response.status);
         }
         return response.json();
     })
     .then(json => {
         this.data = json;

         deps_avant_vague = data["avant_premiere_vague"];
         deps_apres_vague = data["apres_premiere_vague"];
         numeros_deps = data["numeros_departements"];
         all_deps_with_num = deps_avant_vague.concat(deps_apres_vague);

         all_deps_with_num.map((dep, index) => {
          all_deps_with_num[index] = numeros_deps[all_deps_with_num[index]] + " - " + all_deps_with_num[index]

         })

         nb_hosp_dep = data["data"];
         ["maj-1", "maj-2"].forEach(id => {
          document.getElementById(id).innerHTML = document.getElementById(id).innerHTML.replace("-/-", data["date"]);
         })
         


         updateList();

         updateRisks(deps_avant_vague.length, deps_apres_vague.length);

         
      })
     .catch(function () {
         this.dataError = true;
     }
    )


  updateRisks(0, 0);


  function updateRisks(nb_avant_vague, nb_apres_vague) {

    html_deps_avant_vague = "";
    deps_avant_vague.reverse().forEach(dep => {
      link = "https://covidtracker.fr/dashboard-departements/#" + dep

      nb_caract = 9

      dot=""

      if(dep.length > nb_caract-1){
        dot="."
      }

      dep_string = "<span style=\"margin-bottom: -10px; margin-top: 2px; display: inline-block;\"><b>" + dep.substr(0, nb_caract) + dot + "&nbsp;(" + numeros_deps[dep] + ")</b></span><br>"

      progress_bar_wave_1 = "<div class=\"box-perso\"><div style='width: 80%; padding 10px; vertical-align: middle;'><progress style='margin-bottom: -10px !important;' type='greenv1' id='avancement' value='{{value}}' max='{{max}}'></progress>"
        .replace("{{value}}", nb_hosp_dep[dep]["hosp_max_premiere_vague"])
        .replace("{{max}}", nb_hosp_dep[dep]["hosp_actuellement"])

      progress_bar_wave_2 = "<progress style='margin-top: 0px !important;' type='green' id='avancement' value='{{value}}' max='{{max}}'></progress></div>"
        .replace("{{value}}", nb_hosp_dep[dep]["hosp_actuellement"])
        .replace("{{max}}", nb_hosp_dep[dep]["hosp_max_premiere_vague"])
      
      text_evolution = "<div style='vertical-align: bottom;'><span style='font-size: 70%; color: green;'><br>{{text}}&nbsp;%</span></div></div>"
        .replace("{{text}}", calculerTauxEvolution(dep))

      html_deps_avant_vague += "<button type='button_dep' id=\"{{dep}}\" onclick=\"buttonHasChanged('{{dep_func}}', 'false')\"{{dep_string}} {{html_wave_1_html}} {{html_wave_2_html}} {{text_evol_html}} </button>"
        .replace("{{dep}}", replaceBadCharacters(dep))
        .replace("{{dep_func}}", dep.replace("'", "\\'"))
        .replace("{{dep_string}}", dep_string)
        .replace("{{html_wave_1_html}}", progress_bar_wave_1)
        .replace("{{html_wave_2_html}}", progress_bar_wave_2)
        .replace("{{text_evol_html}}", text_evolution)


    })

    document.getElementById("avant_vague").innerHTML = html_deps_avant_vague;
    document.getElementById("nb_avant_vague").innerHTML = nb_avant_vague;

    html_deps_apres_vague = "";

    deps_apres_vague.reverse().forEach(dep => {
      
      link = "https://covidtracker.fr/dashboard-departements/#" + dep

      dot=""

      if(dep.length > 8){
        dot="."
      }


      dep_string = "<span style=\"margin-bottom: -10px; margin-top: 2px; display: inline-block;\"><b>"
       + dep.substr(0,7) + dot + "&nbsp;(" + numeros_deps[dep] + ")</b></span>"

      progress_1 = "<div class=\"box-perso\"><div style='width: 80%;'><progress style='margin-bottom: -10px !important;' type='redv1' id='avancement' value='" + nb_hosp_dep[dep]["hosp_max_premiere_vague"]  + "' max='" + nb_hosp_dep[dep]["hosp_actuellement"] + "'></progress>"
      progress_2 = "<progress style='margin-top: 0px !important;' type='red' id='avancement' value='" + nb_hosp_dep[dep]["hosp_max_premiere_vague"]  + "' max='" + nb_hosp_dep[dep]["hosp_max_premiere_vague"] + "'></progress></div>"
      right_col = "<div style='height:100%; vertical-align: bottom !important;'><span style='font-size: 70%; color: red;'><br>" + calculerTauxEvolution(dep) + "&nbsp;%</span></div></div>"

      html_deps_apres_vague += "<button type='button_dep' id=\"" + replaceBadCharacters(dep) + "\" onclick=\"buttonHasChanged('" + replaceBadCharacters(dep) + "', 'true')\">" + dep_string + progress_1 + progress_2 + right_col + "</button>";

      }
    )

    document.getElementById("apres_vague").innerHTML = html_deps_apres_vague;
    document.getElementById("nb_apres_vague").innerHTML = nb_apres_vague;

  }


  function HtmlEncode(s){
    var el = document.createElement("div");
    el.innerText = el.textContent = s;
    s = el.innerHTML;
    return s;
  }


  function calculerTauxEvolution(dep){
    var taux = Math.round( ( nb_hosp_dep[dep]["hosp_actuellement"] - nb_hosp_dep[dep]["hosp_max_premiere_vague"] ) / nb_hosp_dep[dep]["hosp_max_premiere_vague"]*100 )

    if(taux>0){
      return "+&nbsp;" + taux.toString()
    } else {
      return "-&nbsp;" +Math.abs(taux).toString()
    }
  }

  function buttonHasChanged(depa, a_depasse){
    displayChart(depa, a_depasse);
    scrollToImage();
  }


  function displayChart(depa, a_depasse) {

    depa = depa.replace("'","\'")
    
    document.getElementById("img").innerHTML = "<a href=\"https://raw.githubusercontent.com/rozierguillaume/covid-19/master/images/charts/france/departements_dashboards/hosp_comp_vagues_" + depa + ".jpeg\" target=\"_blank\" rel=\"noopener noreferrer\"><img  id=\"imageTab\" src=\"https://raw.githubusercontent.com/rozierguillaume/covid-19/master/images/charts/france/departements_dashboards/hosp_comp_vagues_" + HtmlEncode(depa) + ".jpeg\" width=\"100%\" style=\"max-width: 900px;\">"
    
    var element = document.getElementById("img");

      updateResult(depa, a_depasse);
  }

  function scrollToImage(){
    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0)
    const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)

    if(vh < 2000){ //vw < 2000 || 
      //location.href = "#";
      //location.href = "#resultat";}
      document.querySelector('#resultat').scrollIntoView({ 
        behavior: 'smooth' 
      });}
  }


  function replaceBadCharacters(dep){
    return dep.replace("'", "&apos;").replace("ô", "&ocirc;")
  }

  function updateList(){
    html_str = "<option value=''>-- Choisissez un département--</option>";

    all_deps_with_num.sort().forEach(dep => {
      dep_seul = dep.replace(new RegExp(".*- "), "")
      value = replaceBadCharacters(dep_seul)
      html_str += "<option value='" + value + "'>" + dep + "</option>"
      }
    )

    document.getElementById("deps_list_choice").innerHTML = html_str;
    
  }

  function updateButtonColor(dep){

    document.getElementById(dep).classList.add("buttonSelected");
    if(selectedDep.length > 0){
      document.getElementById(selectedDep.replace("'", "\'")).classList.remove("buttonSelected");
    }
    selectedDep = dep;
  }


  function updateResult(dep, a_depasse){
    
    updateButtonColor(dep);
    date_depassement = nb_hosp_dep[dep]["jour_depassement"];

    document.getElementById("deps_list_choice").value = dep;

    text_debut = "<span style='margin-top: 10px;'>Le département <b>";
    text_milieu = dep;
    text_fin = " dépassé </b> </span> le nombre de personnes hospitalisées de la première vague.</span><br>";

    deuxiemepartie_1 = "Lors de la vague du printemps 2020, il y a eu jusqu'à <b>" + nb_hosp_dep[dep]["hosp_max_premiere_vague"] + "</b> personnes hospitalisées en simultané pour la Covid19."
    deuxiemepartie_2 = " Lors de la vague actuelle, il y a eu jusqu'à <b>"
    deuxiemepartie_3 = nb_hosp_dep[dep]["hosp_actuellement"] + "</b> personnes hospitalisées en même temps."
    date_depassement_str = ""

    taux = calculerTauxEvolution(dep)
    taux_evolution_str_1 = " La deuxieme vague est <b>" + taux + "&nbsp;%</b> plus "

    if (taux.includes("+")) {
      taux_evolution_str_2 = "haute"
    } else {
      taux_evolution_str_2 = "basse"
    }

    taux_evolution_str_3 = " que la première."

    if(date_depassement != "-/-"){
      date_depassement_str = " La seconde vague a dépassé la première le <b>" + date_depassement + "</b>."
    }

    color = "black";

    if(a_depasse == "true"){
      text_milieu += " a"
      color = "red";
    }
      else{
        text_milieu += " n'a pas"
        color = "green";
      }
    
    document.getElementById("resultat").innerHTML = text_debut + "<span style=\"color:" + color + "\">" + text_milieu + text_fin
    document.getElementById("resultat_chiffres").innerHTML = deuxiemepartie_1 + deuxiemepartie_2 + deuxiemepartie_3 + date_depassement_str + taux_evolution_str_1 + taux_evolution_str_2 + taux_evolution_str_3
  }


  function listHasChanged(){
    dep = document.getElementById("deps_list_choice").value;

    if(deps_avant_vague.includes(dep)){
      a_depasse = "false";
    }
    else{
      a_depasse = "true";
    }

    displayChart(dep, a_depasse);

  }
  </script>
  <!-- /wp:html -->